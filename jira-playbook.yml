---
- name: Installer et configurer le conteneur
  hosts: all
  vars:
    ansible_python_interpreter: /usr/bin/python3
  become: true
  
  tasks:

    - name: Charger les variables
      include_vars:
        file: jira.yml
      tags: variables

    #- name: Add PostgreSQL 12 repository
    #  shell: curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg
    #  shell: echo "deb http://apt.postgresql.org/pub/repos/apt/ `lsb_release -cs`-pgdg main" | sudo tee  /etc/apt/sources.list.d/pgdg.list

    #- name: Mettre a jour les paquets
    #  command: sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 7FCC7D46ACCC4CF8
    #  command: apt update
      
    - name: Installer PostgreSQL {{ psql_version }} et les dépendances
      apt:
        name: 
          - postgresql-{{ psql_version }}
          - postgresql-client-{{ psql_version }}
          - postgresql-contrib-{{ psql_version }}
        state: present

    - name: Activez le service PostgreSQL au démarrage
      service:
        name: postgresql
        enabled: yes
        state: started

    - name: Installer SSH
      apt:
        name: openssh-server
        state: present

    - name: Activez le service SSH au démarrage
      service:
        name: ssh
        enabled: yes
        state: started
       
    - name: Installer Apache
      package:
        name: apache2  # Pour les distributions basées sur Debian (comme Ubuntu)
        state: present
      when: ansible_distribution == 'Ubuntu' or ansible_distribution == 'Debian'

    - name: Activez le service Apache au démarrage
      service:
        name: httpd
        enabled: yes
        state: started
       
    - name: Créer un utilisateur
      user:
        name: jira
        state: present

    - name: Télécharger l'archive Jira
      command: wget -P /atlassian/tmp https://www.atlassian.com/software/jira/downloads/binary/atlassian-jira-software-{{ jira_version }}.tar.gz
